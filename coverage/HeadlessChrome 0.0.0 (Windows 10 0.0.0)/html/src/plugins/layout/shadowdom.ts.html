<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src\plugins\layout\shadowdom.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../prettify.css" />
    <link rel="stylesheet" href="../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../index.html">all files</a> / <a href="index.html">src/plugins/layout/</a> shadowdom.ts
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">80.79% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>185/229</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">55.29% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>47/85</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">77.42% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>24/31</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">80.44% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>181/225</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">314×</span>
<span class="cline-any cline-yes">314×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">121×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">76×</span>
<span class="cline-any cline-yes">76×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-yes">41×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-yes">554×</span>
<span class="cline-any cline-yes">554×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-yes">1113×</span>
<span class="cline-any cline-yes">554×</span>
<span class="cline-any cline-yes">554×</span>
<span class="cline-any cline-yes">554×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import { INodeInfo, IShadowDomMutationSummary, IShadowDomNode, NumberJson } from "../../../types/index";
import { assert, isNumber, traverseNodeTree } from "../../utils";
import { createNodeInfo } from "./nodeinfo";
import { getNodeIndex, NodeIndex } from "./stateprovider";
&nbsp;
// Class names to tag actions that happen to nodes in a single mutation batch
const FinalClassName = "cl-final";
const NewNodeClassName = "cl-new";
const MovedNodeClassName = "cl-moved";
const UpdatedNodeClassName = "cl-updated";
&nbsp;
export class ShadowDom {
  public shadowDocument: IShadowDomNode;
&nbsp;
  private doc = document.implementation.createHTMLDocument("ShadowDom");
  private nextIndex = 0;
  private removedNodes = this.doc.createElement("div");
  private shadowDomRoot = this.doc.createElement("div");
  private classifyNodes = false;
  private nodeMap: { [key: number]: IShadowDomNode } = {};
&nbsp;
  constructor() {
    this.doc.documentElement.appendChild(this.shadowDomRoot);
    this.shadowDocument = document.createElement("div") as IShadowDomNode;
  }
&nbsp;
  public getShadowNode(index: number): IShadowDomNode {
    let node = isNumber(index) ? this.nodeMap[index] : null;
    return node;
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  public getNodeInfo(index: number)</span>: INodeInfo {
<span class="cstat-no" title="statement not covered" >    let shadowNode = this.getShadowNode(index);</span>
<span class="cstat-no" title="statement not covered" >    return shadowNode ? shadowNode.info : null;</span>
  }
&nbsp;
  public insertShadowNode(node: Node, parentIndex: number, nextSiblingIndex: number): IShadowDomNode {
    let isDocument = (node === document);
    let index = this.assignNodeIndex(node);
    let parent = (isDocument ? this.shadowDomRoot : this.getShadowNode(parentIndex)) as IShadowDomNode;
    let nextSibling = this.getShadowNode(nextSiblingIndex);
    let shadowNode = this.doc.createElement("div") as IShadowDomNode;
    shadowNode.id = "" + index;
    shadowNode.node = node;
    shadowNode.computeInfo = () =&gt; {
      let parentNode = shadowNode.parentNode as IShadowDomNode;
      let info = createNodeInfo(node, parentNode ? parentNode.info : <span class="branch-1 cbranch-no" title="branch not covered" >null)</span>;
      shadowNode.info = info;
      return info;
    };
    this.nodeMap[index] = shadowNode;
&nbsp;
    if (isDocument) {
      this.shadowDocument = shadowNode;
    }
&nbsp;
    if (this.classifyNodes) {
      this.setClass(shadowNode, NewNodeClassName);
    }
&nbsp;
    assert(!!parent, "insertShadowNode", "parent is missing");
    <span class="missing-if-branch" title="else path not taken" >E</span>if (parent) {
      if (nextSibling) {
        parent.insertBefore(shadowNode, nextSibling);
      } else {
        parent.appendChild(shadowNode);
      }
    }
&nbsp;
    return shadowNode;
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  public moveShadowNode(index: number, newParentIndex: number, newNextSiblingIndex: number)</span>: IShadowDomNode {
<span class="cstat-no" title="statement not covered" >    let shadowNode = this.getShadowNode(index);</span>
<span class="cstat-no" title="statement not covered" >    let parent = this.getShadowNode(newParentIndex);</span>
<span class="cstat-no" title="statement not covered" >    let nextSibling = this.getShadowNode(newNextSiblingIndex);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    assert(!!parent, "moveShadowNode", "parent is missing");</span>
<span class="cstat-no" title="statement not covered" >    assert(!!shadowNode, "moveShadowNode", "shadowNode is missing");</span>
<span class="cstat-no" title="statement not covered" >    if (parent &amp;&amp; shadowNode) {</span>
<span class="cstat-no" title="statement not covered" >      if (this.classifyNodes) {</span>
<span class="cstat-no" title="statement not covered" >        if (!this.hasClass(shadowNode, NewNodeClassName)) {</span>
<span class="cstat-no" title="statement not covered" >          this.setClass(shadowNode, MovedNodeClassName);</span>
        }
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      if (nextSibling) {</span>
<span class="cstat-no" title="statement not covered" >        parent.insertBefore(shadowNode, nextSibling);</span>
      } else {
<span class="cstat-no" title="statement not covered" >        parent.appendChild(shadowNode);</span>
      }
    }
<span class="cstat-no" title="statement not covered" >    return shadowNode;</span>
  }
&nbsp;
  public updateShadowNode(index: number) {
    let shadowNode = this.getShadowNode(index);
    <span class="missing-if-branch" title="else path not taken" >E</span>if (shadowNode &amp;&amp; this.classifyNodes) {
      this.setClass(shadowNode, UpdatedNodeClassName);
    }
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  public removeShadowNode(index: number)</span> {
<span class="cstat-no" title="statement not covered" >    let shadowNode = this.getShadowNode(index);</span>
<span class="cstat-no" title="statement not covered" >    if (shadowNode) {</span>
<span class="cstat-no" title="statement not covered" >      this.setClass(shadowNode, MovedNodeClassName);</span>
<span class="cstat-no" title="statement not covered" >      this.removedNodes.appendChild(shadowNode);</span>
    }
  }
&nbsp;
  // As we process a batch of mutations, various things can be happening to a single node
  // In the end, however, for each affected node we will have one of the following outcomes:
  //  1. A new node was added
  //  2. Existing node was moved
  //  3. Existing node was removed
  //  4. Existing node was updated
  //  5. Existing node was moved and updated
  // Various actions on a node will lead to different finals states. Also a final state of a parent node
  // can affect and/or override the state of its children (e.g. if node A was moved to node B, but B was removed,
  // that means that A was removed as well). One of the simpler solutions to determining the final states of all
  // affected nodes and its children is 'tagging' shadow nodes with class names based on the mutations as they happen,
  // and then determining the final states of all affected nodes based on the combination of their classes (getting mutation summary).
  // Note: When we process 'remove' action on a node, instead of marking it as removed and permanently removing it from ShadowDOM
  //       and erasing its index, we actually moved it to a separate 'removedNodes' container, which is not part of the representation
  //       of the real DOM, but is still a part of the document. This way, if this node is re-inserted to the page, we can just move
  //       add it back to ShadowDOM and just record the 'Move' event, letting it maintain its index.
  public applyMutationBatch(mutations: MutationRecord[]): IShadowDomMutationSummary {
    let nextIndexBeforeProcessing = this.nextIndex;
    this.doc.documentElement.appendChild(this.removedNodes);
    this.classifyNodes = true;
&nbsp;
    let length = mutations.length;
    for (let i = 0; i &lt; length; i++) {
      let mutation = mutations[i];
      let target = mutation.target;
      switch (mutation.type) {
<span class="branch-0 cbranch-no" title="branch not covered" >        case "attributes":</span>
        case "characterData":
          this.applyUpdate(target, mutation.attributeName, mutation.oldValue);
          break;
        case "childList":
&nbsp;
          // Process inserts
          // We use insertBefore to insert nodes into the shadowDom, so the right sibling needs to be inserted
          // before the left sibling. For that reason we process elements from last to first (right to left)
          let addedLength = mutation.addedNodes.length;
          for (let j = addedLength - 1; j &gt;= 0; j--) {
            let previous = mutation.previousSibling;
            let next = mutation.nextSibling;
            <span class="missing-if-branch" title="if path not taken" >I</span>if (j &gt; 0) {
<span class="cstat-no" title="statement not covered" >              previous = mutation.addedNodes[j - 1];</span>
            }
            <span class="missing-if-branch" title="if path not taken" >I</span>if (j &lt; addedLength - 1) {
<span class="cstat-no" title="statement not covered" >              next = mutation.addedNodes[j + 1];</span>
            }
            this.applyInsert(mutation.addedNodes[j], target, previous, next, false);
          }
&nbsp;
          // Process removes
          let removedLength = mutation.removedNodes.length;
          for (let j = 0; j &lt; removedLength; j++) {
<span class="cstat-no" title="statement not covered" >            this.applyRemove(mutation.removedNodes[j], target);</span>
          }
          break;
<span class="branch-3 cbranch-no" title="branch not covered" >        default:</span>
<span class="cstat-no" title="statement not covered" >          break;</span>
      }
    }
&nbsp;
    // Detach removed nodes
    this.removedNodes.parentElement.removeChild(this.removedNodes);
&nbsp;
    // Process the new state of the ShadowDom and extract the summary
    let summary = this.getMutationSummary();
&nbsp;
    // Clear references to removed nodes and reset shadow dom state to get it ready for the next mutation batch
    this.cleanUp();
&nbsp;
    // Re-assign indices for all new nodes that remained attached to DOM such that there are no gaps between them
    this.reIndexNewNodes(summary.newNodes, nextIndexBeforeProcessing);
&nbsp;
    return summary;
  }
&nbsp;
  public hasClass(shadowNode: IShadowDomNode, className: string) {
    return shadowNode ? shadowNode.classList.contains(className) : <span class="branch-1 cbranch-no" title="branch not covered" >false;</span>
  }
&nbsp;
  public setClass(shadowNode: IShadowDomNode, className: string) {
    <span class="missing-if-branch" title="else path not taken" >E</span>if (shadowNode) {
      shadowNode.classList.add(className);
    }
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  public removeClass(shadowNode: IShadowDomNode, className: string)</span> {
<span class="cstat-no" title="statement not covered" >    if (shadowNode) {</span>
<span class="cstat-no" title="statement not covered" >      shadowNode.classList.remove(className);</span>
    }
  }
&nbsp;
  public removeAllClasses(shadowNode: IShadowDomNode) {
    <span class="missing-if-branch" title="else path not taken" >E</span>if (shadowNode) {
      shadowNode.removeAttribute("class");
    }
  }
&nbsp;
  // As a result of processing mutation batch, some shadow nodes that were affected by mutations have indicative class names.
  // Steps to creating a mutation summary from these nodes are the following:
  //  1. Record 'Insert' events on nodes with NewNodeClassName. We can ignore and remove other classes on such nodes, because it
  //     doesn't matter if this node was also moved around or updated - it's new, so we record its state from scratch anyways.
  //  2. Record 'Move' events on remaining nodes with MovedNodeClassName class.
  //  3. Record 'Update' events on remaining nodes with UpdatedNodeClassName class (there can be nodes that were moved AND updated).
  //  4. Inspect nodes inside the 'removedNodes' container:
  //    - Ignore nodes that have NewNodeClassName class. They are new and were not in the ShadowDom to begin with
  //    - Record a 'Remove' event for nodes that have MovedNodeClassName. They were explicitly moved and ended up in the 'removed' container
  //    - Ignore remaining nodes. Since they weren't explicitly moved, they will be auto-removed through the subtree of their removed parent
  public getMutationSummary(): IShadowDomMutationSummary {
    let summary: IShadowDomMutationSummary = {
      newNodes: [],
      movedNodes: [],
      updatedNodes: [],
      removedNodes: []
    };
&nbsp;
    // Collect all new nodes in the top-down order
    let newNodes = Array.prototype.slice.call(this.doc.getElementsByClassName(NewNodeClassName));
    for (let i = 0; i &lt; newNodes.length; i++) {
      let newNode = newNodes[i] as IShadowDomNode;
      summary.newNodes.push(newNode);
      this.removeAllClasses(newNode);
    }
&nbsp;
    let moved = Array.prototype.slice.call(this.doc.getElementsByClassName(MovedNodeClassName));
    for (let i = 0; i &lt; moved.length; i++) {
<span class="cstat-no" title="statement not covered" >      let next = moved[i] as IShadowDomNode;</span>
<span class="cstat-no" title="statement not covered" >      summary.movedNodes.push(next);</span>
<span class="cstat-no" title="statement not covered" >      this.removeClass(next, MovedNodeClassName);</span>
    }
&nbsp;
    let updated = Array.prototype.slice.call(this.doc.getElementsByClassName(UpdatedNodeClassName));
    for (let i = 0; i &lt; updated.length; i++) {
<span class="cstat-no" title="statement not covered" >      let next = updated[i] as IShadowDomNode;</span>
<span class="cstat-no" title="statement not covered" >      summary.updatedNodes.push(next);</span>
<span class="cstat-no" title="statement not covered" >      this.removeAllClasses(next);</span>
    }
&nbsp;
    traverseNodeTree(this.removedNodes, <span class="fstat-no" title="function not covered" >(removedNode: IShadowDomNode)</span> =&gt; {
<span class="cstat-no" title="statement not covered" >      if (this.hasClass(removedNode, MovedNodeClassName) &amp;&amp; !this.hasClass(removedNode, NewNodeClassName)) {</span>
<span class="cstat-no" title="statement not covered" >        summary.removedNodes.push(removedNode);</span>
      }
    }, false);
&nbsp;
    return summary;
  }
&nbsp;
  public createIndexJson(rootNode: Node, getIndexFromNode: (node: Node) =&gt; number): NumberJson {
    let indexJson: NumberJson = [];
    this.writeIndexToJson(rootNode, indexJson, getIndexFromNode);
    return indexJson;
  }
&nbsp;
  public isConsistent(): boolean {
    return this.isConstentSubtree(document, this.shadowDocument);
  }
&nbsp;
  private cleanUp() {
&nbsp;
    // For each removed dom node, remove its index and its shadow dom reference
    traverseNodeTree(this.removedNodes, <span class="fstat-no" title="function not covered" >(removedNode: IShadowDomNode)</span> =&gt; {
<span class="cstat-no" title="statement not covered" >      let index = getNodeIndex(removedNode.node);</span>
<span class="cstat-no" title="statement not covered" >      delete removedNode.node[NodeIndex];</span>
<span class="cstat-no" title="statement not covered" >      delete this.nodeMap[index];</span>
    }, false);
&nbsp;
    // Reset the state of the shadow dom to be ready for next mutation batch processing
    let finalNodes = Array.prototype.slice.call(this.doc.getElementsByClassName(FinalClassName));
    for (let i = 0; i &lt; finalNodes.length; i++) {
<span class="cstat-no" title="statement not covered" >      this.removeAllClasses(finalNodes[i]);</span>
    }
    this.removedNodes.innerHTML = "";
    this.classifyNodes = false;
  }
&nbsp;
  private writeIndexToJson(node: Node, json: NumberJson, getIndexFromNode: (node: Node) =&gt; number) {
    let index = getIndexFromNode(node);
    let childJson: number[] = [];
    let nextChild = node.firstChild;
    json.push(index);
    if (nextChild) {
      json.push(childJson);
    }
    while (nextChild) {
      this.writeIndexToJson(nextChild, childJson, getIndexFromNode);
      nextChild = nextChild.nextSibling as IShadowDomNode;
    }
  }
&nbsp;
  private isConsistentNode(node: Node, shadowNode: IShadowDomNode): boolean {
    let index = getNodeIndex(node);
    return (isNumber(index) &amp;&amp; shadowNode.id === (index).toString() &amp;&amp; shadowNode.node === node);
  }
&nbsp;
  private isConstentSubtree(node: Node, shadowNode: IShadowDomNode): boolean {
    let isConsistent = this.isConsistentNode(node, shadowNode);
    let nextChild: Node = node.firstChild;
    let nextShadowChild: Node = shadowNode.firstChild;
    while (isConsistent) {
      if (nextChild &amp;&amp; nextShadowChild) {
        isConsistent = this.isConstentSubtree(nextChild, nextShadowChild as IShadowDomNode);
        nextChild = nextChild.nextSibling;
        nextShadowChild = nextShadowChild.nextSibling;
      } else <span class="missing-if-branch" title="if path not taken" >I</span>if (nextChild || nextShadowChild) {
<span class="cstat-no" title="statement not covered" >        isConsistent = false;</span>
      } else {
        break;
      }
    }
    return isConsistent;
  }
&nbsp;
  private applyInsert(addedNode: Node, parent: Node, previousSibling: Node, nextSibling: Node, force: boolean) {
    let addedNodeIndex = getNodeIndex(addedNode);
    let parentIndex = getNodeIndex(parent);
    let nextSiblingIndex = getNodeIndex(nextSibling);
    let validMutation = this.shouldProcessChildListMutation(addedNode, parent) || force;
    if (validMutation) {
      // If inserted node has no index, then it's a new node and we should process insert
      <span class="missing-if-branch" title="else path not taken" >E</span>if (addedNodeIndex === null) {
        let shadowNode = this.insertShadowNode(addedNode, parentIndex, nextSiblingIndex);
        this.setClass(shadowNode, FinalClassName);
&nbsp;
        // Process children
        // We use insertBefore to insert nodes into the shadowDom, so the right sibling needs to be inserted
        // before the left sibling. For that reason we process children from last to first (right to left)
        let nextChild: Node = addedNode.lastChild;
        while (nextChild) {
          this.applyInsert(nextChild, addedNode, nextChild.previousSibling, nextChild.nextSibling, true);
          nextChild = nextChild.previousSibling;
        }
      } else {
<span class="cstat-no" title="statement not covered" >        this.moveShadowNode(addedNodeIndex, parentIndex, getNodeIndex(nextSibling));</span>
      }
    }
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  private applyRemove(removedNode: Node, parent: Node)</span> {
<span class="cstat-no" title="statement not covered" >    let removedNodeIndex = getNodeIndex(removedNode);</span>
<span class="cstat-no" title="statement not covered" >    if (removedNodeIndex !== null) {</span>
<span class="cstat-no" title="statement not covered" >      let validMutation = this.shouldProcessChildListMutation(removedNode, parent);</span>
<span class="cstat-no" title="statement not covered" >      if (validMutation) {</span>
<span class="cstat-no" title="statement not covered" >        this.removeShadowNode(removedNodeIndex);</span>
      }
    }
  }
&nbsp;
  private applyUpdate(updatedNode: Node, attrName: string, oldValue: string) {
    let updatedNodeIndex = getNodeIndex(updatedNode);
    <span class="missing-if-branch" title="else path not taken" >E</span>if (updatedNodeIndex != null) {
      this.updateShadowNode(updatedNodeIndex);
    }
  }
&nbsp;
  // We want to determine whether we can skip this mutation without losing data. We can do so in 2 cases:
  //  1. This is a mutation for a node that is marked as 'Final'. These are the new nodes for which we already know final position,
  //     because we have discovered them by traversing other inserted node's subtree in the real page DOM. For such final nodes,
  //     we already recorded the insert action to the appropriate position, so all other mutations can be ignored.
  //  2. This is a mutation, which attempts to add or remove a node from the child list of the node, which is marked final. For such
  //     nodes, we have already processed their entire child list in the real page DOM and all children received an insert action.
  //     This means that any other mutations are either temporary (insert something that will end up being removed) or redundant, so
  //     we can skip them
  private shouldProcessChildListMutation(child: Node, parent: Node) {
    let childNodeIndex = getNodeIndex(child);
    let parentIndex = getNodeIndex(parent);
    let parentShadowNode = null;
    if (childNodeIndex === null) {
      parentShadowNode = this.getShadowNode(parentIndex);
    } else {
      let childShadowNode = this.getShadowNode(childNodeIndex);
      parentShadowNode = childShadowNode &amp;&amp; childShadowNode.parentNode;
    }
    return parentShadowNode &amp;&amp; !this.hasClass(parentShadowNode, FinalClassName);
  }
&nbsp;
  // When we apply a mutation batch, we assign a new index to every node that is added to the DOM as we parse mutations
  // in their natural order. However, some of those nodes end up being again removed from DOM with some follow-up mutation
  // thus 'stealing' an index with them. Since we don't instrument nodes that were added and removed within the same
  // mutation batch, we have no records of these stolen indices. To maintain consistency on the backend, at the end of the mutation,
  // we can re-assign indices for all nodes that remained attached to the DOM such that they all go in increasing order without gaps
  private reIndexNewNodes(newNodes: IShadowDomNode[], nextIndex: number) {
    newNodes.map((shadowNode: IShadowDomNode) =&gt; {
      let index = getNodeIndex(shadowNode.node);
      delete this.nodeMap[index];
    });
    newNodes.map((shadowNode: IShadowDomNode) =&gt; {
      shadowNode.node[NodeIndex] = nextIndex;
      shadowNode.id = `${nextIndex}`;
      this.nodeMap[nextIndex] = shadowNode;
      nextIndex++;
    });
    this.nextIndex = nextIndex;
  }
&nbsp;
  private assignNodeIndex(node: Node): number {
    let index = getNodeIndex(node);
    <span class="missing-if-branch" title="else path not taken" >E</span>if (index === null) {
      index = this.nextIndex;
      this.nextIndex++;
    }
    node[NodeIndex] = index;
    return index;
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Jan 21 2019 19:01:37 GMT-0800 (Pacific Standard Time)
</div>
</div>
<script src="../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../sorter.js"></script>
</body>
</html>
