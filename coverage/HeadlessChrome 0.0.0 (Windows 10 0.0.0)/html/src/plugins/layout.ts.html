<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src\plugins\layout.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">src/plugins/</a> layout.ts
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">65.03% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>106/163</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">43.08% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>28/65</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">73.68% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>14/19</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">65.22% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>105/161</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">136×</span>
<span class="cline-any cline-yes">136×</span>
<span class="cline-any cline-yes">136×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">100×</span>
<span class="cline-any cline-yes">100×</span>
<span class="cline-any cline-yes">100×</span>
<span class="cline-any cline-yes">100×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">100×</span>
<span class="cline-any cline-yes">100×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">559×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import { Action, IElementLayoutState, IEventData, ILayoutRoutineInfo, ILayoutState, IMutationRoutineInfo,
  INodeInfo, InsertRuleHandler, Instrumentation, IPlugin, IShadowDomInconsistentEventState, IShadowDomMutationSummary, IShadowDomNode,
  IStyleLayoutState, LayoutRoutine, NumberJson, Source } from "../../types/index";
import { config } from "./../config";
import { addEvent, addMultipleEvents, bind, getTimestamp, instrument } from "./../core";
import { debug, mask, traverseNodeTree } from "./../utils";
import { ShadowDom } from "./layout/shadowdom";
import { getCssRules, getNodeIndex, NodeIndex, resetStateProvider } from "./layout/stateprovider";
&nbsp;
export default class Layout implements IPlugin {
  private readonly cssTimeoutLength = 50;
  private eventName = "Layout";
  private distanceThreshold = 5;
  private shadowDom: ShadowDom;
  private inconsistentShadowDomCount: number;
  private observer: MutationObserver;
  private insertRule: InsertRuleHandler;
  private cssTimeout: number;
  private cssElementQueue: Element[];
  private watchList: boolean[];
  private mutationSequence: number;
  private lastConsistentDomJson: NumberJson;
  private firstShadowDomInconsistentEvent: IShadowDomInconsistentEventState;
&nbsp;
  public reset(): void {
    this.shadowDom = new ShadowDom();
    this.inconsistentShadowDomCount = 0;
    this.watchList = [];
    this.cssElementQueue = [];
    this.observer = window["MutationObserver"] ? new MutationObserver(this.mutation.bind(this)) : <span class="branch-1 cbranch-no" title="branch not covered" >null;</span>
    this.insertRule = CSSStyleSheet.prototype.insertRule;
    this.mutationSequence = 0;
    this.lastConsistentDomJson = null;
    this.firstShadowDomInconsistentEvent = null;
    resetStateProvider();
  }
&nbsp;
  public activate(): void {
    this.discoverDom();
    <span class="missing-if-branch" title="else path not taken" >E</span>if (this.observer) {
      this.observer.observe(document, {
        attributes: true,
        childList: true,
        characterData: true,
        subtree: true
      });
    }
    <span class="missing-if-branch" title="else path not taken" >E</span>if (this.insertRule) {
      let that = this;
&nbsp;
      // Some popular open source libraries, like styled-components, optimize performance
      // by injecting CSS using insertRule API vs. appending text node. A side effect of
      // using javascript API is that it doesn't trigger DOM mutation and therefore we
      // need to override the insertRule API and listen for changes manually.
      CSSStyleSheet.prototype.insertRule = <span class="fstat-no" title="function not covered" >function(style, index)</span> {
<span class="cstat-no" title="statement not covered" >        let value = that.insertRule.call(this, style, index);</span>
<span class="cstat-no" title="statement not covered" >        that.queueCss(this.ownerNode);</span>
<span class="cstat-no" title="statement not covered" >        return value;</span>
      };
    }
  }
&nbsp;
  public teardown(): void {
    <span class="missing-if-branch" title="else path not taken" >E</span>if (this.observer) {
      this.observer.disconnect();
    }
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (this.cssTimeout) {
<span class="cstat-no" title="statement not covered" >      clearTimeout(this.cssTimeout);</span>
    }
&nbsp;
    // Restore original insertRule definition
    <span class="missing-if-branch" title="else path not taken" >E</span>if (this.insertRule) {
      CSSStyleSheet.prototype.insertRule = this.insertRule;
    }
    this.insertRule = null;
&nbsp;
    // Clean up node indices on observed nodes
    // If Clarity is re-activated within the same page later,
    // old, uncleared indices would cause it to work incorrectly
    let documentShadowNode = this.shadowDom.shadowDocument;
    <span class="missing-if-branch" title="else path not taken" >E</span>if (documentShadowNode.node) {
      delete documentShadowNode.node[NodeIndex];
    }
    let otherNodes = this.shadowDom.shadowDocument.querySelectorAll("*");
    for (let i = 0; i &lt; otherNodes.length; i++) {
      let node = (otherNodes[i] as IShadowDomNode).node;
      <span class="missing-if-branch" title="else path not taken" >E</span>if (node) {
        delete node[NodeIndex];
      }
    }
  }
&nbsp;
  private discoverDom() {
    // All 'Discover' events together should be treated as an atomic 'Discover' operation and should have the same timestamp
    const discoverTime = getTimestamp();
    traverseNodeTree(document, (node: Node) =&gt; {
      let nodeInfo = this.discoverNode(node);
      nodeInfo.state.action = Action.Insert;
      nodeInfo.state.source = Source.Discover;
      addEvent({
        type: this.eventName,
        state: nodeInfo.state,
        time: discoverTime,
      });
    });
    this.checkConsistency({
      action: LayoutRoutine.DiscoverDom
    });
  }
&nbsp;
  // Add node to the ShadowDom to store initial adjacent node info in a layout and obtain an index
  private discoverNode(node: Node): INodeInfo {
    let shadowNode = this.shadowDom.insertShadowNode(node, getNodeIndex(node.parentNode), getNodeIndex(node.nextSibling));
    return shadowNode.computeInfo();
  }
&nbsp;
  private watch(node: Node, nodeLayoutState: ILayoutState) {
&nbsp;
    // We only wish to watch elements once and then wait on the events to push changes
    if (node.nodeType !== Node.ELEMENT_NODE || this.watchList[nodeLayoutState.index]) {
      return;
    }
&nbsp;
    let element = node as Element;
    let layoutState = nodeLayoutState as IElementLayoutState;
    let scrollPossible = (layoutState.layout
                          &amp;&amp; ("scrollX" in layoutState.layout
                          || "scrollY" in layoutState.layout));
&nbsp;
    if (scrollPossible) {
      bind(element, "scroll", this.layoutHandler.bind(this, element, Source.Scroll));
      this.watchList[layoutState.index] = true;
    }
&nbsp;
    // Check if we need to monitor changes on input fields
    <span class="missing-if-branch" title="if path not taken" >I</span>if (element.tagName === "INPUT" || element.tagName === "SELECT") {
<span class="cstat-no" title="statement not covered" >      bind(element, "change", this.layoutHandler.bind(this, element, Source.Input));</span>
<span class="cstat-no" title="statement not covered" >      this.watchList[layoutState.index] = true;</span>
    } else <span class="missing-if-branch" title="if path not taken" >I</span>if (element.tagName === "TEXTAREA") {
<span class="cstat-no" title="statement not covered" >      bind(element, "input", this.layoutHandler.bind(this, element, Source.Input));</span>
<span class="cstat-no" title="statement not covered" >      this.watchList[layoutState.index] = true;</span>
    }
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  private queueCss(element: Element)</span> {
    // Clear the timeout if it already exists
<span class="cstat-no" title="statement not covered" >    if (this.cssTimeout) {</span>
<span class="cstat-no" title="statement not covered" >      clearTimeout(this.cssTimeout);</span>
    }
&nbsp;
    // Queue element to be processed after the timeout triggers
<span class="cstat-no" title="statement not covered" >    if (this.cssElementQueue.indexOf(element) === -1) {</span>
<span class="cstat-no" title="statement not covered" >      this.cssElementQueue.push(element);</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    this.cssTimeout = setTimeout(this.cssDequeue.bind(this), this.cssTimeoutLength);</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  private cssDequeue() {</span>
<span class="cstat-no" title="statement not covered" >    for (<span class="cstat-no" title="statement not covered" >let element </span>of this.cssElementQueue) {</span>
<span class="cstat-no" title="statement not covered" >      this.layoutHandler(element, Source.Css);</span>
    }
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  private layoutHandler(element: Element, source: Source)</span> {
<span class="cstat-no" title="statement not covered" >    let index = getNodeIndex(element);</span>
<span class="cstat-no" title="statement not covered" >    let nodeInfo = this.shadowDom.getNodeInfo(index);</span>
<span class="cstat-no" title="statement not covered" >    if (nodeInfo) {</span>
<span class="cstat-no" title="statement not covered" >      let layoutState = nodeInfo.state as IElementLayoutState;</span>
<span class="cstat-no" title="statement not covered" >      switch (source) {</span>
        case Source.Scroll:
<span class="cstat-no" title="statement not covered" >          let scrollX = Math.round(element.scrollLeft);</span>
<span class="cstat-no" title="statement not covered" >          let scrollY = Math.round(element.scrollTop);</span>
<span class="cstat-no" title="statement not covered" >          let dx = layoutState.layout.scrollX - scrollX;</span>
<span class="cstat-no" title="statement not covered" >          let dy = layoutState.layout.scrollY - scrollY;</span>
<span class="cstat-no" title="statement not covered" >          if (dx * dx + dy * dy &gt; this.distanceThreshold * this.distanceThreshold) {</span>
<span class="cstat-no" title="statement not covered" >            layoutState.source = source;</span>
<span class="cstat-no" title="statement not covered" >            layoutState.action = Action.Update;</span>
<span class="cstat-no" title="statement not covered" >            layoutState.layout.scrollX = scrollX;</span>
<span class="cstat-no" title="statement not covered" >            layoutState.layout.scrollY = scrollY;</span>
<span class="cstat-no" title="statement not covered" >            addEvent({type: this.eventName, state: layoutState});</span>
          }
<span class="cstat-no" title="statement not covered" >          break;</span>
        case Source.Input:
<span class="cstat-no" title="statement not covered" >          let input = element as HTMLInputElement;</span>
<span class="cstat-no" title="statement not covered" >          let showText = config.showText &amp;&amp; !nodeInfo.forceMask;</span>
<span class="cstat-no" title="statement not covered" >          layoutState.attributes.value = showText ? input.value : mask(input.value);</span>
<span class="cstat-no" title="statement not covered" >          layoutState.source = source;</span>
<span class="cstat-no" title="statement not covered" >          layoutState.action = Action.Update;</span>
<span class="cstat-no" title="statement not covered" >          addEvent({type: this.eventName, state: layoutState});</span>
<span class="cstat-no" title="statement not covered" >          break;</span>
        case Source.Css:
<span class="cstat-no" title="statement not covered" >          let styleState = nodeInfo.state as IStyleLayoutState;</span>
<span class="cstat-no" title="statement not covered" >          styleState.cssRules = getCssRules(element as HTMLStyleElement);</span>
<span class="cstat-no" title="statement not covered" >          styleState.source = source;</span>
<span class="cstat-no" title="statement not covered" >          styleState.action = Action.Update;</span>
<span class="cstat-no" title="statement not covered" >          addEvent({type: this.eventName, state: styleState});</span>
<span class="cstat-no" title="statement not covered" >          break;</span>
        default:
<span class="cstat-no" title="statement not covered" >          break;</span>
      }
    }
  }
&nbsp;
  private mutation(mutations: MutationRecord[]) {
&nbsp;
    // Don't process mutations on top of the inconsistent state.
    // ShadowDom mutation processing logic requires consistent state as a prerequisite.
    // If we end up in the inconsistent state, that means that something went wrong already,
    // so we can give up on the following mutations and should investigate the cause of the error.
    // Continuing to process mutations can result in javascript errors and lead to even more inconsistencies.
    <span class="missing-if-branch" title="else path not taken" >E</span>if (this.allowMutation()) {
&nbsp;
      // Perform mutations on the shadow DOM and make sure ShadowDom arrived to the consistent state
      let time = getTimestamp();
      let summary = this.shadowDom.applyMutationBatch(mutations);
      let actionInfo: IMutationRoutineInfo = {
        action: LayoutRoutine.Mutation,
        mutationSequence: this.mutationSequence,
        batchSize: mutations.length
      };
      this.checkConsistency(actionInfo);
      <span class="missing-if-branch" title="else path not taken" >E</span>if (this.allowMutation()) {
        this.processMutations(summary, time);
      }
    }
&nbsp;
    this.mutationSequence++;
  }
&nbsp;
  private allowMutation(): boolean {
    return this.inconsistentShadowDomCount &lt; 2 || <span class="branch-1 cbranch-no" title="branch not covered" >!config.validateConsistency;</span>
  }
&nbsp;
  private processMutations(summary: IShadowDomMutationSummary, time: number): void {
    let inserts = summary.newNodes.map(this.processMutation.bind(this, Action.Insert));
    let moves = summary.movedNodes.map(this.processMutation.bind(this, Action.Move));
    let updates = summary.updatedNodes.map(this.processMutation.bind(this, Action.Update));
    let removes = summary.removedNodes.map(this.processMutation.bind(this, Action.Remove));
    let all: IEventData[] = [].concat(inserts, moves, updates, removes);
&nbsp;
    // Since we receive batched mutations and reprocess them after, all mutation events from the same batch
    // should be treated as a single atomic operation, so all of those events should have the same timestamp
    for (let i = 0; i &lt; all.length; i++) {
      all[i].time = time;
    }
    addMultipleEvents(all);
  }
&nbsp;
  private processMutation(action: Action, shadowNode: IShadowDomNode): IEventData {
    let state = shadowNode.computeInfo().state;
    state.action = action;
    state.source = Source.Mutation;
    state.mutationSequence = this.mutationSequence;
&nbsp;
    // Watch new or updated nodes
    <span class="missing-if-branch" title="else path not taken" >E</span>if (action === Action.Insert || <span class="branch-1 cbranch-no" title="branch not covered" >action </span>=== Action.Update) {
      this.watch(shadowNode.node, state);
    } else <span class="cstat-no" title="statement not covered" >if (action === Action.Remove) {</span>
      // Removed nodes don't have an index any more, so computed state index will be null,
      // however its original index can still be obtained from its matching shadow node id
<span class="cstat-no" title="statement not covered" >      state.index = parseInt(shadowNode.id, 10);</span>
    }
&nbsp;
    return { type: this.eventName, state };
  }
&nbsp;
  private checkConsistency(lastActionInfo: ILayoutRoutineInfo): void {
    <span class="missing-if-branch" title="else path not taken" >E</span>if (config.validateConsistency) {
      let domJson = this.shadowDom.createIndexJson(document, (node: Node) =&gt; {
        return getNodeIndex(node);
      });
      let shadowDomConsistent = this.shadowDom.isConsistent();
      <span class="missing-if-branch" title="if path not taken" >I</span>if (!shadowDomConsistent) {
<span class="cstat-no" title="statement not covered" >        this.inconsistentShadowDomCount++;</span>
<span class="cstat-no" title="statement not covered" >        let shadowDomJson = this.shadowDom.createIndexJson(this.shadowDom.shadowDocument, <span class="fstat-no" title="function not covered" >(node: Node)</span> =&gt; {</span>
<span class="cstat-no" title="statement not covered" >          return parseInt((node as IShadowDomNode).id, 10);</span>
        });
<span class="cstat-no" title="statement not covered" >        let evt: IShadowDomInconsistentEventState = {</span>
          type: Instrumentation.ShadowDomInconsistent,
          dom: domJson,
          shadowDom: shadowDomJson,
          lastConsistentShadowDom: this.lastConsistentDomJson,
          lastAction: lastActionInfo
        };
<span class="cstat-no" title="statement not covered" >        if (this.inconsistentShadowDomCount &lt; 2) {</span>
<span class="cstat-no" title="statement not covered" >          this.firstShadowDomInconsistentEvent = evt;</span>
        } else {
<span class="cstat-no" title="statement not covered" >          evt.firstEvent = this.firstShadowDomInconsistentEvent;</span>
<span class="cstat-no" title="statement not covered" >          instrument(evt);</span>
        }
<span class="cstat-no" title="statement not covered" >        debug(`&gt;&gt;&gt; ShadowDom doesn't match PageDOM after mutation batch #${this.mutationSequence}!`);</span>
      } else {
        this.inconsistentShadowDomCount = 0;
        this.firstShadowDomInconsistentEvent = null;
        this.lastConsistentDomJson = domJson;
      }
    }
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Jan 21 2019 19:01:37 GMT-0800 (Pacific Standard Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
