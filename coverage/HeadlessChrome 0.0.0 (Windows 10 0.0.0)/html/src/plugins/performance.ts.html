<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src\plugins\performance.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">src/plugins/</a> performance.ts
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">85.71% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>66/77</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">58.97% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>23/39</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>10/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">85.71% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>66/77</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">611×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import { IPerformanceResourceTimingState, IPerformanceTimingState, IPlugin } from "../../types/index";
import { config } from "../config";
import { addEvent } from "../core";
import { mapProperties } from "../utils";
&nbsp;
export const NavigationTimingEventType = "NavigationTiming";
export const ResourceTimingEventType = "ResourceTiming";
export const PerformanceStateErrorEventType = "PerformanceStateError";
&nbsp;
export default class PerformanceProfiler implements IPlugin {
&nbsp;
  private readonly timeoutLength = 1000;
&nbsp;
  private urlBlacklist: string[];
  private lastInspectedEntryIndex: number;
  private logTimingTimeout: number;
  private logResourceTimingTimeout: number;
&nbsp;
  // For performance reasons this module relies on the fact that array returned from the
  // getEntries function is a superset of the array returned from that function on previous inspection.
  // If that is not the case (e.g. performance.clearResourceTimings() was used), then
  // some entries may be missed and consistency is not guaranteed.
  // Set this flag to 'true' if we detect that something went wrong (e.g. new array length &lt; lastInspectedEntryIndex)
  private stateError = false;
&nbsp;
  // IE has a very 'unique' way of working with performance entries
  // Each time you invoke getEntries() it returns a list of brand new objects,
  // even if those objects describe the same network entries, but at least it maintains the order.
  // Besides that, IE returns performance entries for resources that are not finished loading yet,
  // so duration, responseEnd and other values can be '0' until you re-inspect getEntries() later.
  // To be able to come back to those incomplete entries, we will store their indices for revisiting.
  private incompleteEntryIndices: number[] = [];
&nbsp;
  private timing: PerformanceTiming;
  private getEntriesByType: (type: string) =&gt; PerformanceEntry[];
&nbsp;
  public activate() {
    <span class="missing-if-branch" title="else path not taken" >E</span>if (this.timing) {
      this.logTimingTimeout = setTimeout(this.logTiming.bind(this), this.timeoutLength);
    }
    <span class="missing-if-branch" title="else path not taken" >E</span>if (this.getEntriesByType) {
      this.logResourceTimingTimeout = setTimeout(this.logResourceTiming.bind(this), this.timeoutLength);
    }
  }
&nbsp;
  public reset(): void {
    this.lastInspectedEntryIndex = -1;
    this.stateError = false;
    this.incompleteEntryIndices = [];
    this.urlBlacklist = config.urlBlacklist.map(this.getFullUrl);
    // we need to blacklist our own uploadUrl, otherwise we get into an infinite loop of instrumenting the calls we make
    // to the uploadUrl. Each of our instrumentation calls gets instrumented and we ended up POSTing multiple times per second.
    this.urlBlacklist.push(this.getFullUrl(config.uploadUrl));
&nbsp;
    // Potentially these don't need resets because performance object doesn't normally change within the page
    // The reason for resetting these values on each activation is for easier testing
    // This way this component would pick up a dummy performance object for reliable unit testing
    this.timing = window.performance &amp;&amp; performance.timing;
    this.getEntriesByType = window.performance
      &amp;&amp; typeof performance.getEntriesByType === "function"
      &amp;&amp; performance.getEntriesByType.bind(performance);
  }
&nbsp;
  public teardown() {
    clearTimeout(this.logTimingTimeout);
    clearTimeout(this.logResourceTimingTimeout);
  }
&nbsp;
  private logTiming() {
    <span class="missing-if-branch" title="else path not taken" >E</span>if (this.timing.loadEventEnd &gt; 0) {
      let formattedTiming = this.timing.toJSON ? this.timing.toJSON() : <span class="branch-1 cbranch-no" title="branch not covered" >this.timing;</span>
      formattedTiming = mapProperties(formattedTiming, (name: string, value) =&gt; {
        return (formattedTiming[name] === 0) ? 0 : Math.round(formattedTiming[name] - formattedTiming.navigationStart);
      }, false);
      let navigationTimingEventState: IPerformanceTimingState = {
        timing: formattedTiming
      };
      addEvent({type: NavigationTimingEventType, state: navigationTimingEventState});
    } else {
<span class="cstat-no" title="statement not covered" >      this.logTimingTimeout = setTimeout(this.logTiming.bind(this), this.timeoutLength);</span>
    }
  }
&nbsp;
  private logResourceTiming() {
    let entries = this.getEntriesByType("resource");
&nbsp;
    // If entries.length &lt; lastInspectedEntry + 1, most likely some entries have
    // been cleared, which would cause inconsistencies in further entries inspection.
    // In case this happens, log an error once and reset the module to its initial state
    <span class="missing-if-branch" title="if path not taken" >I</span>if (entries.length &lt; this.lastInspectedEntryIndex + 1) {
<span class="cstat-no" title="statement not covered" >      if (!this.stateError) {</span>
<span class="cstat-no" title="statement not covered" >        this.stateError = true;</span>
<span class="cstat-no" title="statement not covered" >        addEvent({type: PerformanceStateErrorEventType, state: {}});</span>
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      this.lastInspectedEntryIndex = -1;</span>
<span class="cstat-no" title="statement not covered" >      this.incompleteEntryIndices = [];</span>
    }
&nbsp;
    let incompleteEntryIndicesCopy = this.incompleteEntryIndices.slice();
&nbsp;
    this.incompleteEntryIndices = [];
&nbsp;
    // First, revisit the entries that were identified as incomplete upon last inspection
    for (let i = 0; i &lt; incompleteEntryIndicesCopy.length; i++) {
<span class="cstat-no" title="statement not covered" >      let entryIndex = incompleteEntryIndicesCopy[i];</span>
<span class="cstat-no" title="statement not covered" >      let networkData = this.inspectEntry(entries[entryIndex], entryIndex);</span>
<span class="cstat-no" title="statement not covered" >      if (networkData) {</span>
<span class="cstat-no" title="statement not covered" >        addEvent({type: ResourceTimingEventType, state: networkData});</span>
      }
    }
&nbsp;
    // Then, inspect fresh entries
    for (let i = this.lastInspectedEntryIndex + 1; i &lt; entries.length; i++) {
      let networkData = this.inspectEntry(entries[i], i);
      <span class="missing-if-branch" title="else path not taken" >E</span>if (networkData) {
        addEvent({type: ResourceTimingEventType, state: networkData});
      }
      this.lastInspectedEntryIndex = i;
    }
&nbsp;
    this.logResourceTimingTimeout = setTimeout(this.logResourceTiming.bind(this), this.timeoutLength);
  }
&nbsp;
  private inspectEntry(entry, entryIndex): IPerformanceResourceTimingState {
    let networkData: IPerformanceResourceTimingState = null;
    <span class="missing-if-branch" title="else path not taken" >E</span>if (entry &amp;&amp; entry.responseEnd &gt; 0) {
      <span class="missing-if-branch" title="else path not taken" >E</span>if (this.urlBlacklist.indexOf(entry.name) &lt; 0) {
        networkData = {
          duration: entry.duration,
          initiatorType: entry.initiatorType,
          startTime: entry.startTime,
          connectStart: entry.connectStart,
          connectEnd: entry.connectEnd,
          requestStart: entry.requestStart,
          responseStart: entry.responseStart,
          responseEnd: entry.responseEnd,
          name: entry.name
        };
&nbsp;
        // These properties only exist in new browsers
        // They also don't need rounding, because they are measured in bytes
        <span class="missing-if-branch" title="else path not taken" >E</span>if ("transferSize" in entry) {
          networkData.transferSize = entry.transferSize;
        }
        <span class="missing-if-branch" title="else path not taken" >E</span>if ("encodedBodySize" in entry) {
          networkData.encodedBodySize = entry.encodedBodySize;
        }
        <span class="missing-if-branch" title="else path not taken" >E</span>if ("decodedBodySize" in entry) {
          networkData.decodedBodySize = entry.decodedBodySize;
        }
        <span class="missing-if-branch" title="else path not taken" >E</span>if ("nextHopProtocol" in entry) {
          networkData.protocol = entry.nextHopProtocol;
        }
&nbsp;
        networkData = mapProperties(networkData, (name: string, value) =&gt; {
          return (typeof value === "number") ? Math.round(value) : value;
        }, true) as IPerformanceResourceTimingState;
      }
    } else {
<span class="cstat-no" title="statement not covered" >      this.incompleteEntryIndices.push(entryIndex);</span>
    }
&nbsp;
    return networkData;
  }
&nbsp;
  private getFullUrl(partialUrl: string): string {
    let dummyLink = document.createElement("a");
    dummyLink.href = partialUrl;
    return dummyLink.href;
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Jan 21 2019 19:11:04 GMT-0800 (Pacific Standard Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
